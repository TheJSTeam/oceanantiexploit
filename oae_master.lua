-- OAE

local gid = game.PlaceId
local players = game:GetService("Players")
local oaesettings = require(script.OAESettings)
local http = game:GetService("HttpService")
local name

if game.CreatorType == Enum.CreatorType.Group then
	name = game:GetService("GroupService"):GetGroupInfoAsync(game.CreatorId).Owner.Name
else
	name = players:GetNameFromUserIdAsync(game.CreatorId)
end

local data = http:GetAsync("https://oceanantiexploit-default-rtdb.firebaseio.com/Users/"..name.."/games/"..gid..".json") or false
if http:JSONDecode(data) ~= nil then

	local plrchars = {
		--plrname = {lfSP = vector3, lfC = character}
	}

	local debounce = false

	local watchlist = {}

	local suspicious = {
		--plrname = {cf = 0, pv = vector3}
	}

	local kickMessage = "~~~~~~~~~~\nðŸŒŠ oceanantiexploit ðŸŒŠ\n~~~~~~~~~~\n %s detected! \n~~~~~~~~~~" -- %s will be replaced with the exploit used
	local kickMessageWithData ="~~~~~~~~~~\nðŸŒŠ oceanantiexploit ðŸŒŠ\n~~~~~~~~~~\n %s detected! \n~~~~~~~~~~\n  %s \n~~~~~~~~~~" -- Second %s will be data

	local wbapi = require(script.Dependencies.OAEWebhook)
	local post

	if oaesettings.UseDiscordWebhook then
		post = wbapi.new(oaesettings.DiscordWebhookID, oaesettings.DiscordWebhookKey)
	end

	local function punish(plr, thing, mdata)
		if not debounce then
			debounce = true
			if not table.find(oaesettings.Whitelist, plr.UserId) then
				local data = 
					{
						["content"] = "",
						["embeds"] = {{
							["title"] = "**oceanantiexploit**",
							["description"] = plr.Name.." was kicked for exploiting.",
							["type"] = "rich",
							["color"] = tonumber(0xffffff),
							["footer"] = {
								["icon_url"] = "https://i.ibb.co/NnvrLdL/oaelosos.png",
								["text"] = "oceanantiexploit beta",
							},
							["fields"] = {
								{
									["name"] = "Exploit Detected",
									["value"] = thing,
									["inline"] = true
								}
							}
						}}
					}
				if oaesettings.UseDiscordWebhook then
					post:post(data)
				end

				if mdata then
					plr:Kick(string.format("\n"..kickMessageWithData, thing, mdata))
				else
					plr:Kick(string.format("\n"..kickMessage, thing))	
				end
			end
			wait(1)
			debounce = false
		end
	end

	game:GetService("RunService").Stepped:Connect(function()
		for i,v in pairs(plrchars) do
			if v.lfC then
				local rp = RaycastParams.new()
				rp.FilterDescendantsInstances = {v.lfC}
				rp.FilterType = Enum.RaycastFilterType.Blacklist
				if v.lfC:FindFirstChild("HumanoidRootPart") then
					local r = workspace:Raycast(v.lfSP, v.lfC.HumanoidRootPart.Position-v.lfSP, rp)
					if r then
						if r.Instance.CanCollide == true then
							punish(game:GetService("Players"):FindFirstChild(i), "NoClip")
						end
					end

					v.lfSP = v.lfC.HumanoidRootPart.Position
				end
			else
				plrchars[i] = nil
			end
		end
		for i,v in pairs(game:GetService("Players"):GetPlayers()) do
			if not plrchars[v.Name] then
				if v.Character then
					plrchars[v.Name] = {lfSP = v.Character.HumanoidRootPart.Position, lfC = v.Character}
				end
			else
				if v.Character ~= plrchars[v.Name].lfC then
					plrchars[v.Name].lfC = v.Character
				end
			end
		end
	end)

--[[game.ReplicatedStorage.oae_detect.OnServerEvent:Connect(function(plr, r)
	if r == "dx" and AntiDex then
		punish(plr, "Dex Injection")
	end
end)]]--

	while wait(1) do
		for i,v in pairs(plrchars) do
			local p = game.Players:FindFirstChild(i)
			if p then
				local s = script.Dependencies.oaeagent:Clone()
				s.Parent = p.PlayerGui
				s.Disabled = false
				s.oae_rebound.OnServerEvent:Connect(function(plr,ws,jp,r,l,ts,y,d,a,da,oh,rs,rs2,rt,es)
					s:Destroy()
					if ws ~= v.lfC.Humanoid.WalkSpeed and oaesettings.AntiSpeed then
						punish(game:GetService("Players"):FindFirstChild(i), "Illegal WalkSpeed", "Expected "..v.lfC.Humanoid.WalkSpeed.." but got "..ws.."!")
					end
					if jp ~= v.lfC.Humanoid.JumpPower and oaesettings.AntiJump then
						punish(game:GetService("Players"):FindFirstChild(i), "Illegal JumpPower", "Expected "..v.lfC.Humanoid.JumpPower.." but got "..jp.."!")
					end
					if not r and es ~= 15 and plr.Character:FindFirstChild("HumanoidRootPart") and oaesettings.AntiNoHRP then
						punish(game:GetService("Players"):FindFirstChild(i), "Character Tampering", "No HumanoidRootPart Detected!")
					end
					if es == 11 and oaesettings.AntiStateChange then
						punish(game:GetService("Players"):FindFirstChild(i), "Illegal State")
					end
					if ts ~= plr.Character.Humanoid.PlatformStand and oaesettings.AntiIllegalAttributes then
						punish(game:GetService("Players"):FindFirstChild(i), "Character Tampering", "Illegal Attribute Detected!")
					end
					if oaesettings.AntiDex then
						for j,k in pairs(l) do
							if string.find(k.message, "ExplorerPanel") or string.find(k.message, "PropertiesPanel") then
								punish(game:GetService("Players"):FindFirstChild(i), "Dark Dex Injection")
							elseif string.find(k.message, "DownloadString") then
								punish(game:GetService("Players"):FindFirstChild(i), "Synapse Dex Injection")
							elseif string.find(k.message, "protect_gui") or string.find(k.message, "-- < Services > --") then
								punish(game:GetService("Players"):FindFirstChild(i), "Synapse Dex Injection")
							end
						end
						if d ~= false or da ~= false then
							punish(game:GetService("Players"):FindFirstChild(i), "Synapse Dex Injection")
						end
					end
					if y ~= false and oaesettings.AntiInfiniteYield then
						punish(game:GetService("Players"):FindFirstChild(i), "Infinite Yield Injection")
					end
					if a ~= true and oaesettings.AntiOAETampering then
						punish(game:GetService("Players"):FindFirstChild(i), "OAE Tampering")
					end
					if oh ~= false and oaesettings.AntiOwlHub then
						punish(game:GetService("Players"):FindFirstChild(i), "OwlHub Injection")
					end
					if rs ~= false or rs2 ~= false and oaesettings.AntiRemoteSpy then
						punish(game:GetService("Players"):FindFirstChild(i), "Remote Spy Injection")
					end
				end)
			end
		end
	end
else
	if oaesettings.LicenseKey ~= "" then
		print("               ")
		print("               ")
		print("               ")
		print("OAE> Hello there! It seems like OAE isn't quite set up yet.")
		print("OAE> In order to activate your game with OAE, you must visit this game link: https://www.roblox.com/games/6302744557/OAESetup")
		print("OAE> Login with your license key and add '"..gid.."' as a game in the games tab.")
		print("OAE> After you add and activate this game, come back here!")
	else
		print("               ")
		print("               ")
		print("OAE> Hello there! To set up OAE, follow the instructions found in OAESettings.")
	end
end
